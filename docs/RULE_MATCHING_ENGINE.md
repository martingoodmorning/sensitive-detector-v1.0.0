# 规则匹配引擎

## 概述

规则匹配引擎是一个高效的敏感词检测系统，采用文本预处理+分层检测策略，结合了文本归一化、AC自动机和DFA状态机的优势，实现了快速、精准、全面的敏感词检测。

## 架构设计

### 第一步：文本预处理
- **目的**：统一字符格式，消除无意义变体
- **原理**：对输入文本进行字符归一化处理，包括全角转半角、繁体转简体、特殊符号移除等
- **优势**：将各种变体形式统一为标准格式，提高后续匹配的准确性
- **输出**：归一化后的标准文本

### 第二步：AC自动机初筛（对归一化文本）
- **目的**：快速过滤无风险文本，标记可疑文本
- **原理**：使用AC自动机算法，一次性扫描归一化文本，快速识别可能的敏感词匹配
- **优势**：时间复杂度O(n+m+z)，其中n是文本长度，m是模式总长度，z是匹配数量
- **输出**：直接匹配的敏感词列表 + 可疑文本片段

### 第三步：DFA检测（性能优先策略）
- **目的**：在 AC 未命中时，复核“插字规避”场景；AC 命中时为性能优先不再重复校验
- **原理**：
  - AC 命中时：跳过 DFA（避免重复计算，降低延迟）
  - AC 未命中时：对原始文本执行“容噪”DFA 复核，以提升“插字规避”场景的召回
  - 容噪规则：仅在中文词内部允许跳过少量 ASCII 字母/数字（不含下划线），默认参数为“单次最多跳过 10 个、整段累计最多 100 个”
- **优势**：显著降低在大词库/长文本下的延迟，同时保持对插字扰动的召回能力
- **输出**：将 DFA 命中结果与 AC 结果合并去重（AC 命中场景下 DFA 为空）

## 工作流程

```
输入文本
    ↓
第一步：文本预处理
    ↓
归一化文本
    ↓
第二步：AC自动机初筛（对归一化文本）
    ↓
若 AC 命中：直接进入“合并结果”
若 AC 未命中：第三步：DFA检测（对原始文本，容噪复核）
    ↓
合并所有结果
    ↓
最终检测结果
```

## API响应格式

```json
{
  "status": "success",
  "data": {
    "original_text": "检测的文本内容...",
    "rule_detection": {
      "ac_results": ["微信", "密码"],
      "dfa_results": ["微信", "密码"],
      "all_results": ["微信", "密码"],
      "suspicious_segments": ["可疑文本片段1", "可疑文本片段2"],
      "normalized_text": "归一化后的文本内容",
      "preprocess_results": [],
      "word_count": 2,
      "timing": {
        "preprocess_time": 1.2,
        "ac_time": 2.5,
        "dfa_time": 1.8,
        "total_time": 5.5
      }
    },
    "llm_detected": "正常",
    "llm_time": 0,
    "final_result": "正常",
    "detection_flow": "rule_only"
  }
}
```

## 性能特点

1. **高效性**：AC 提供 O(n+m+z)；DFA 仅在 AC 未命中时执行，显著降低总体延迟
2. **准确性**：容噪 DFA 针对 ASCII 字母/数字插字（不含下划线），限定跳过上限
3. **全面性**：预处理统一变体；AC 未命中时由 DFA 弥补插字扰动
4. **可扩展性**：词库增大主要影响构建时间与状态数；运行时随文本长度线性增长

## 使用示例

### 直接匹配
- 输入：`"请提供您的微信账号和密码"`
- 预处理：`"请提供您的微信账号和密码"`（无变化）
- 结果：AC自动机和DFA都能检测到"微信"和"密码"

### 变体匹配（预处理后统一）
- 输入：`"请添加我的微❤信账号"`
- 预处理：`"请添加我的微信账号"`（移除特殊符号）
- 结果：AC自动机和DFA都能检测到"微信"

### 全角半角变体
- 输入：`"需要您的身份证号和银行卡信息"`
- 预处理：`"需要您的身份证号和银行卡信息"`（全角转半角）
- 结果：AC自动机和DFA都能检测到"身份证"和"银行卡"

### 插字容噪匹配
- 输入：`"这是敏q感q词，请注意"`
- 预处理：保持原样（容噪在 DFA 阶段处理）
- 结果：AC 未命中时触发；容噪 DFA 依据“单次≤10、累计≤100”策略命中“敏感词”

## 配置说明

规则匹配引擎默认使用`word_libraries/`目录中的所有词库文件，支持通过词库管理功能动态配置。

敏感词库文件格式：每行一个敏感词，UTF-8编码。

## 文本预处理功能

### 字符归一化规则

1. **全角转半角**：将全角字符转换为半角字符
   - 全角字母：ＡＢＣ → ABC
   - 全角数字：１２３ → 123
   - 全角符号：（），。 → (),.

2. **繁体转简体**：将繁体字转换为简体字
   - 學習 → 学习
   - 經濟 → 经济
   - 電腦 → 电脑

3. **特殊符号移除**：移除特殊符号，保留中文字符、英文字母、数字
   - 微❤信 → 微信
   - 支付-宝 → 支付宝
   - 微_信 → 微信

### 预处理优势

- **统一变体**：将各种变体形式统一为标准格式
- **提高准确性**：减少因字符格式差异导致的漏检
- **简化匹配**：后续AC和DFA匹配更加精确
